

Платформа для автовебинаров на коленке

Вступление

Иногда человек изобретает то, что уже было изобретено до него. Радость от гениальной идеи сменяется грустью от того, что эту идею придумал кто-то другой. Именно так я "изобрел" для себя автовебинары пару лет назад. 

[TL;DR] ссылка на репозиторий GitHub.

Я не любитель онлайн-школ, бизнес-тренингов, продавцов успешного успеха и честно не подозревал о существовании такого маркетингового инструмента как автовебинар. Просто потому что не интересовался.
Вероятно кто-то из читателей не знает что это.

Автовебинар – это симуляция живого вебинара.

Схема такая:
1) Вы видите рекламу вебинара, заходите на сайт и регистрируетесь
2) В назначенный час получаете на почту ссылку для входа в "вебинарную комнату" (веб-страница с видео-плеером и чатом)
3) Трансляция записанного заранее видео запускается автоматически в определенное время.
4) Ведущий рассказывает об интересующих вас вещах и, возможно что-то продает вам с экрана
5) Ведущий активно работает со зрителями: просит писать в чат свои вопросы и ставить "+", если зрители согласны.
6) Чат пестрит смайлами и вопросами, и на "самые интересные вопросы" ведущий успевает отвечать.
7) 95% людей думают, что это "прямой эфир" и не подозревают что это запись видео и чата, которая запускается автоматически каждую неделю

Смысл автовебинаров в том, чтобы автоматизировать продажи каких либо продуктов и при этом.

Оставим морально-этическую сторону вопроса, хорошо так делать или нет. В мире победившего капитализма деньги не пахнут;
Сделаем свою небольшую платформу для автовебинаров и каждый сам решит, как использовать этот инструмент.

Делаем собственную авто-вебинарную платформу

Основные задачи:
1) Сделать видео-трансляцию симулирующую прямой эфир. котораю будет запускаться автоматически, которую нельзя будет перематать.
2) Сделать чат, в который можно написать и в котором сообщения от других людей появляются автоматически
3) Собрать это все в единый проект, добавить страницу регистрации на вебинар и емейл-рассылку о начале вебинара

Итак, я буду использовать:
- Debian VPS. Можете выбрать другой, на ваше усмотрение, но хостинг не подойдет.
- Веб-сервер NGINX – будет использоваться в для раздачи видео
- ffmpeg 
- PHP – для бэкенда. Я не буду использовать фреймворки, чтобы любой желающий мог разобраться с кодом.
- Нативный JS + немного JQuery для фронтенда



Задача №1 – превращаем видео в прямой эфир

Итак, нам необходимо взять заранее записанное видео и каким-то образом научиться запускать его трансляцию автоматически, например в 12:00. Если пользовать пользователь зашел на страницу в 12:05 - он должен увидеть видео с 12:05 - опоздал к началу - твои проблемы. Если пользователь ушел со страницы вебинара и вернулся на нее в 12:10 - видео должно сразу транслироваться с 12:10.

Самое первое что приходит в голову - взять HTML5-плеер и перематывать в нем видео с помощью JS на нужную секунду при входе на страницу. Но у этого варианта есть как минимум две проблемы:
1) часовые пояса, возможность изменить время браузера. С этим еще можно бороться с помощью синхронизации времени с сервером.
2) ссылка на видео-файл можно будет подглядеть в src плеера: видео легко будет стащить через консоль разработчика в любом браузере.

Я решил пойти другим путем и стал искать информацию, как организовать стриминг видео с самого обычного Linux сервера.
Я нагуглил десяток разных софтин, многие из которых работали только с Windows серверами, некоторые были очень сложны в установке, некоторые уже не поддерживались. Хотелось какого-то простого решения. К большой радости наткнулся на две статьи на Хабре: https://habr.com/ru/post/145867/ (Вещание онлайн-видео с помощью nginx) и https://habr.com/ru/post/174089/ (Онлайн вещание через Nginx-RTMP: несколько готовых рецептов). 

Итак, реализовать вещание видео с сервера мы будем с помощью модуля для Nginx - nginx-rtmp-module (исходники тут https://github.com/arut/nginx-rtmp-module) и ffmpeg.
С помощью ffmpeg будем превращать заранее подготовленный видеофайл в RTMP-поток, а Nginx раздаст его всем подключившимся пользователям.

Пробуем запустить

Итак, берем свежую VPS-ку, и выполняем установку нужных пакетов. Я работаю с Debian 10, если вы выбрали другой дистрибутив - процесс настройки может отличаться.

apt update
apt upgrade
apt install nginx nginx-extras libnginx-mod-rtmp ffmpeg

Далее необходимо дополнить конфигурацию nginx (отредактировать файл /etc/nginx/nginx.conf). В самый низ файла добавляем конфигурацию RTMP:

rtmp {
        server {
                listen 1935;
                chunk_size 4096;

                application webinar {
                        live on;
                        record off;
                        hls on;
                        hls_path /tmp/hls;
                        hls_fragment 5s;

                }
        }
}


Загрузим на сервер тестовый файл (я положил его в /home/webinar/1.mp4) и пробуем запустить его трансляцию.

	ffmpeg -re -ss 663 -i /home/webinar/1.mp4 -c copy -f flv rtmp://localhost/webinar/mystream

Проверить можно с помощью VLC: 






Задача №2 – чат авто-вебинара
Задача №3 - страница вебинарной комнаты, регистрации и рассылка уведомлений


